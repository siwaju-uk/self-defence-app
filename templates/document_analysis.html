{% extends "base.html" %}

{% block title %}Document Analysis - Self-Defence{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="mb-4">
                <div class="d-flex align-items-center mb-3">
                    <h1 class="me-3">üìã Document Analysis</h1>
                    <a href="/chat" class="btn btn-outline-secondary">
                        <i class="fas fa-comments"></i> Back to Chat
                    </a>
                </div>
                <p class="text-muted">
                    Upload claimant's skeleton arguments, statements of case, or other legal documents to receive AI-powered defence strategy analysis and counterargument suggestions.
                </p>
            </div>

            <!-- Upload Section -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-upload text-primary"></i> Upload Document
                    </h5>
                </div>
                <div class="card-body">
                    <form id="documentUploadForm" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="documentFile" class="form-label">Select Document</label>
                            <input type="file" class="form-control" id="documentFile" name="document" 
                                   accept=".pdf,.doc,.docx,.txt" required>
                            <div class="form-text">
                                Supported formats: PDF, Word (.docx), Text (.txt). Maximum size: 16MB
                            </div>
                        </div>
                        
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary" id="uploadBtn">
                                <i class="fas fa-brain"></i> Analyze Document
                            </button>
                        </div>
                    </form>
                    
                    <!-- Progress indicator -->
                    <div id="uploadProgress" class="mt-3" style="display: none;">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm me-2" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <span>Analyzing document with AI... This may take a few moments.</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analysis Results -->
            <div id="analysisResults" style="display: none;">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-shield-alt text-success"></i> Defence Strategy Analysis
                        </h5>
                        <small class="text-muted" id="analysisTimestamp"></small>
                    </div>
                    <div class="card-body">
                        <div id="analysisContent" class="markdown-content">
                            <!-- Analysis results will be inserted here -->
                        </div>
                        
                        <hr class="my-4">
                        
                        <div class="alert alert-warning">
                            <strong>‚ö†Ô∏è Important Legal Disclaimer:</strong>
                            This analysis is generated by AI and is for informational purposes only. It does not constitute legal advice. 
                            Always consult with a qualified solicitor for case-specific guidance and professional legal representation.
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button class="btn btn-success" onclick="continueToChat()">
                                <i class="fas fa-comments"></i> Discuss in Chat
                            </button>
                            <button class="btn btn-outline-primary" onclick="downloadAnalysis()">
                                <i class="fas fa-download"></i> Save Analysis
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Document History -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-history text-info"></i> Recent Document Analyses
                    </h5>
                </div>
                <div class="card-body">
                    <div id="documentHistory">
                        <div class="text-center text-muted py-3">
                            <i class="fas fa-file-alt fa-2x mb-2"></i>
                            <p>No documents analyzed yet. Upload your first document above.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.markdown-content h1 {
    font-size: 1.5rem;
    color: var(--bs-primary);
    border-bottom: 2px solid var(--bs-primary);
    padding-bottom: 0.5rem;
    margin-bottom: 1rem;
}

.markdown-content h2 {
    font-size: 1.3rem;
    color: var(--bs-secondary);
    margin-top: 2rem;
    margin-bottom: 1rem;
}

.markdown-content h3 {
    font-size: 1.1rem;
    color: var(--bs-dark);
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
}

.markdown-content ul {
    padding-left: 1.5rem;
}

.markdown-content li {
    margin-bottom: 0.5rem;
}

.markdown-content strong {
    color: var(--bs-dark);
}

.document-history-item {
    border: 1px solid var(--bs-border-color);
    border-radius: 0.375rem;
    padding: 1rem;
    margin-bottom: 0.75rem;
    transition: all 0.2s ease;
}

.document-history-item:hover {
    background-color: var(--bs-light);
    border-color: var(--bs-primary);
}

.file-upload-area {
    border: 2px dashed var(--bs-border-color);
    border-radius: 0.375rem;
    padding: 2rem;
    text-align: center;
    transition: all 0.2s ease;
}

.file-upload-area:hover {
    border-color: var(--bs-primary);
    background-color: var(--bs-light);
}

#documentFile {
    border: 2px dashed var(--bs-border-color);
    padding: 1rem;
    border-radius: 0.375rem;
}

#documentFile:focus {
    border-color: var(--bs-primary);
    box-shadow: 0 0 0 0.2rem rgba(var(--bs-primary-rgb), 0.25);
}
</style>

<script>
let lastAnalysis = null;

document.addEventListener('DOMContentLoaded', function() {
    loadDocumentHistory();

    const uploadForm = document.getElementById('documentUploadForm');
    uploadForm.addEventListener('submit', handleDocumentUpload);
});

async function handleDocumentUpload(event) {
    event.preventDefault();

    const fileInput = document.getElementById('documentFile');
    const uploadBtn = document.getElementById('uploadBtn');
    const uploadProgress = document.getElementById('uploadProgress');
    const analysisResults = document.getElementById('analysisResults');

    if (!fileInput.files[0]) {
        alert('Please select a file to upload.');
        return;
    }

    uploadBtn.disabled = true;
    uploadProgress.style.display = 'block';
    analysisResults.style.display = 'none';

    const formData = new FormData();
    formData.append('document', fileInput.files[0]);

    try {
        const response = await fetch('/api/upload-document', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (result.success) {
            lastAnalysis = result;
            displayAnalysis(result.formatted_response, result.filename);
            displayEnrichedArguments(result.enriched_arguments);
            fileInput.value = '';
            loadDocumentHistory();
        } else {
            alert('Error: ' + result.error);
        }

    } catch (error) {
        console.error('Upload error:', error);
        alert('An error occurred while uploading the document. Please try again.');
    } finally {
        uploadBtn.disabled = false;
        uploadProgress.style.display = 'none';
    }
}

function displayAnalysis(formattedResponse, filename) {
    const analysisResults = document.getElementById('analysisResults');
    const analysisContent = document.getElementById('analysisContent');
    const analysisTimestamp = document.getElementById('analysisTimestamp');

    const htmlContent = formatMarkdownToHTML(formattedResponse);

    analysisContent.innerHTML = htmlContent;
    analysisTimestamp.textContent = `Analysis completed: ${new Date().toLocaleString()}`;

    analysisResults.style.display = 'block';
    analysisResults.scrollIntoView({ behavior: 'smooth' });
}

function displayEnrichedArguments(enrichedArguments) {
    if (!enrichedArguments || enrichedArguments.length === 0) return;

    const analysisContent = document.getElementById('analysisContent');
    const enrichedSection = document.createElement('div');
    enrichedSection.innerHTML = `<h2>üîç Argument Breakdown with CPR & Case Law References</h2>`;

    enrichedArguments.forEach((item, index) => {
        const argBlock = document.createElement('div');
        argBlock.classList.add('mb-4');

        argBlock.innerHTML = `
            <h3>${index + 1}. ${item.argument}</h3>
            <h4 class="mt-3 text-primary">Relevant CPR Rules:</h4>
            <ul>${item.cpr_rules.map(rule => `<li>${rule}</li>`).join('')}</ul>
            <h4 class="mt-3 text-success">Relevant Case Laws:</h4>
            <ul>${item.case_laws.map(law => `<li>${law}</li>`).join('')}</ul>
        `;

        enrichedSection.appendChild(argBlock);
    });

    analysisContent.appendChild(enrichedSection);
}

function formatMarkdownToHTML(text) {
    return text
        .replace(/^# (.*$)/gim, '<h1>$1</h1>')
        .replace(/^## (.*$)/gim, '<h2>$1</h2>')
        .replace(/^### (.*$)/gim, '<h3>$1</h3>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\n\n/g, '</p><p>')
        .replace(/\n/g, '<br>');
}

async function loadDocumentHistory() {
    try {
        const response = await fetch('/api/document-history');
        const history = await response.json();

        const historyContainer = document.getElementById('documentHistory');

        if (history.length === 0) {
            historyContainer.innerHTML = `
                <div class="text-center text-muted py-3">
                    <i class="fas fa-file-alt fa-2x mb-2"></i>
                    <p>No documents analyzed yet. Upload your first document above.</p>
                </div>
            `;
        } else {
            historyContainer.innerHTML = history.map(doc => `
                <div class="document-history-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-1">
                                <i class="fas fa-file-alt text-primary"></i>
                                ${doc.filename}
                            </h6>
                            <p class="mb-1 text-muted">${doc.analysis_summary}</p>
                            <small class="text-muted">
                                <i class="fas fa-calendar"></i> ${new Date(doc.created_at).toLocaleDateString()}
                                ‚Ä¢ <i class="fas fa-pound-sign"></i> ${doc.claim_value_estimate.toLocaleString()}
                                ‚Ä¢ <i class="fas fa-layer-group"></i> ${doc.track_type.replace('_', ' ').toUpperCase()}
                            </small>
                        </div>
                        <span class="badge bg-secondary">${doc.document_type.replace('_', ' ')}</span>
                    </div>
                </div>
            `).join('');
        }
    } catch (error) {
        console.error('Error loading document history:', error);
    }
}

function continueToChat() {
    if (lastAnalysis) {
        sessionStorage.setItem('lastDocumentAnalysis', JSON.stringify(lastAnalysis));
    }
    window.location.href = '/chat';
}

async function downloadAnalysis() {
    if (lastAnalysis) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        let content = `Defence Analysis - ${lastAnalysis.filename}\n\n`;
        content += lastAnalysis.formatted_response + '\n\n';

        if (lastAnalysis.enriched_arguments && lastAnalysis.enriched_arguments.length > 0) {
            content += "Argument Breakdown with CPR & Case Law References:\n\n";
            lastAnalysis.enriched_arguments.forEach((item, index) => {
                content += `${index + 1}. ${item.argument}\n`;
                content += `  Relevant CPR Rules:\n    - ${item.cpr_rules.join('\n    - ')}\n`;
                content += `  Relevant Case Laws:\n    - ${item.case_laws.join('\n    - ')}\n\n`;
            });
        }

        const lines = doc.splitTextToSize(content, 180);
        doc.text(lines, 10, 10);
        doc.save(`defence-analysis-${lastAnalysis.filename}.pdf`);
    }
}

</script>
{% endblock %}